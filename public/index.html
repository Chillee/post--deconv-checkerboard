<!doctype html>
<meta charset="utf-8">
<script src="http://distill.pub/template.min.js"></script>
<dt-header></dt-header>
<link rel="stylesheet" type="text/css" href="assets/w_page.css">
<script src="assets/d3.min.js"></script>
<script src="assets/d3-path.min.js"></script>
<script src="assets/underscore.js"></script>
<script src="assets/vis_functions.js"></script>

<script type="text/front-matter">
  title: Deconvolution and Checkerboard Artifacts
  description: When we look very closely at images generated by neural networks, we often see a strange checkerboard pattern of artifacts.
  published: Oct 17, 2016
  authors:
  - Augustu Odena
  - Vincent Dumoulin: http://vdumoulin.github.io/
  - Chris Olah: http://colah.github.io
  affiliations:
  - Google Brain: http://g.co/brain
  - Université de Montréal: https://mila.umontreal.ca/en/
  - Google Brain: http://g.co/brain
</script>


<dt-article markdown>
  # Deconvolution and Checkerboard Artifacts

  <dt-byline></dt-byline>

  When we look very closely at images generated by neural networks, we often see a strange checkerboard pattern of artifacts. It's more obvious in some cases than others, but a large fraction of recent models exhibit this behavior.
  <div class="w-body">
    <dt-include src="assets/samples.html" class="w-body"></dt-include>
  </div>

  Mysteriously, the checkerboard pattern tends to be most prominent in images with strong colors.
  What's going on? Do neural networks hate bright colors? The actual cause of these artifacts is actually remarkably simple, as is a method for avoiding them.

  ---

  ## Deconvolution & Overlap

  When we have neural networks generate images, we often have them build them up
  from low resolution, high-level descriptions.
  This allows the network to describe the rough image and then fill in the details.

  In order to do this, we need some way to go from a lower resolution image to a higher one.
  We generally do this with the *deconvolution* operation.
  Roughly, deconvolution layers allow the model to use every point
  in the small image to "paint" a square in the larger one.

  (Deconvolution has a number of interpretations and different names, including "transposed convolution."
  We use the name "deconvolution" in this article for brevity.
  For excellent discussion of deconvolution, see <dt-cite key="dumoulin2016guide,shi2016deconvolution"></dt-cite>.)

  Unfortunately, deconvolution can easily have "uneven overlap,"
  putting more of the metaphorical paint in some places than others (<dt-cite key="gauthier2014conditional"></dt-cite>).
  In particular, deconvolution has uneven overlap when the kernel size (the output window size) is not divisible by the stride (the spacing between points on the top).
  While the network could, in principle, carefully learn weights to avoid this
  -- as we'll discuss in more detail later --
  in practice neural networks struggle to avoid it completely.

  <dt-include src="assets/deconv1d.html"></dt-include>

  The overlap pattern also forms in two dimensions.
  The uneven overlaps on the two axes multiply together,
  creating a characteristic checkerboard-like pattern of varying magnitudes.

  <dt-include src="assets/deconv2d.html"></dt-include>

  In fact, the uneven overlap tends to be more extreme in two dimensions!
  Because the two patterns are multiplied together, the unevenness gets squared.
  For example, in one dimension, a stride 2, size 3 deconvolution has some outputs with twice the number of inputs as others,
  but in two dimensions this becomes a factor of four.

  Now, neural nets typically use multiple layers of deconvolution when creating images,
  iteratively building a larger image out of a series of lower resolution descriptions.
  While it's possible for these stacked deconvolutions to cancel out artifacts,
  they often compound, creating artifacts on a variety of scales.

  <dt-include src="assets/deconv1d_multi.html"></dt-include>

  Stride 1 deconvolutions --
  which we often see as the last layer in successful models (eg. <dt-cite key="salimans2016improved"></dt-cite>)
  -- are quite effective at dampening artifacts.
   They can remove artifacts of frequencies
  that divide their size, and reduce others artifacts of frequency less than their
  size. However, artifacts can still leak through, as seen in many recent models.

  In addition to the high frequency checkerboard-like artifacts we observed above,
  early deconvolutions can create lower-frequency artifacts,
  which we'll explore in more detail later.

  These artifacts tend to be most prominent when outputting unusual colors.
  Since neural network layers typically have a bias
  (a learned value added to the output) it's easy to output the average color.
  The further a color -- like bright red -- is away from the average color,
  the more deconvolution needs to contribute.

  -----
  ## Overlap & Learning

  Thinking about things in terms of uneven overlap is -- while a useful framing --
  kind of simplistic. For better or worse, our models learn weights for their deconvolutions.

  In theory, our models could learn to carefully write to unevenly overlapping positions so that the output
  is evenly balanced.

  <figure class="w-page">
  <img src="assets/upsample_LearnedConvUneven.svg">
  </figure>

  This is a tricky balancing act to achieve, especially when one has multiple channels interacting.
  Avoiding artifacts significantly restricts the possible filters, sacrificing model capacity.
  In practice, neural networks struggle to learn to completely avoid these patterns.

  In fact, not only do models with uneven overlap not learn to avoid this,
  but models with even overlap often learn kernels that cause similar artifacts!
  While it isn't their default behavior the way it is for uneven overlap,
  it's still very easy for even overlap deconvolution to cause artifacts.

  <figure class="w-page">
  <img src="assets/upsample_LearnedConvEven.svg">
  </figure>

  Completely avoiding artifacts is still a significant restriction on filters,
  and in practice the artifacts are still present in these models, although they seem milder.
  (See <dt-cite key="dumoulin2016adversarially"></dt-cite>,
  which uses stride 2 size 4 deconvolutions, as an example.)

  There are probably a lot of factors at play here.
  For example, in the case of Generative Adversarial Networks (GANs), one issue may be the discriminator and its gradients
  (we'll discuss this more later).
  But a big part of the problem seems to be deconvolution.
  At best, deconvolution is fragile because it very easily represents artifact creating functions, even when the size is carefully chosen.
  At worst, creating artifacts is the default behavior of deconvolution.

  Is there a different way to upsample that is more resistant to artifacts?

  -----
  ## Better Upsampling

  To avoid these artifacts, we'd like an alternative to regular deconvolution ("transposed convolution").
  Unlike deconvolution, this approach to upsampling shouldn't have artifacts as its default behavior.
  Ideally, it would go further, and be biased against such artifacts.

  One approach is to make sure you use a kernel size that is divided by your stride,
  avoiding the overlap issue.
  This is equivalent to "sub-pixel convolution," a technique which has recently
  had success in image super-resolution (<dt-cite key="shi2016real"></dt-cite>).
  However, while this approach helps, it is still easy for deconvolution to fall into creating artifacts.


  Another approach is to separate out upsampling to a higher resolution from convolution to compute features.
  For example, you might resize the image (using [nearest-neighbor interpolation](https://en.wikipedia.org/wiki/Nearest-neighbor_interpolation) or [bilinear interpolation](https://en.wikipedia.org/wiki/Bilinear_interpolation)) and then do a convolutional layer.
  This seems like a natural approach, and roughly similar methods have worked well in image super-resolution (eg. <dt-cite key="dong2014image"></dt-cite>).

  <figure class="w-page">
  <img src="assets/upsample_DeconvTypes.svg">
  </figure>

  Both deconvolution and the different resize-convolution approaches are linear operations, and can be interpreted as matrices.
  This a helpful way to see the differences between them.
  Where deconvolution has a unique entry for each output window, resize-convolution is implicitly weight-tying in a way that discourages high frequency artifacts.

  We've had our best results with nearest-neighbor interpolation, and had difficulty making bilinear resize work.
  This may simply mean that, for our models, the nearest-neighbor happened to work well with hyper-parameters optimized for deconvolution.
  It might also point at trickier issues with naively using bilinear interpolation, where it resists high-frequency image features too strongly.
  We don't necessarily think that either approach is the final solution to upsampling, but they do fix the checkerboard artifacts.

  ### Code

  Resize-convolution layers can be easily implemented in TensorFlow using [`tf.image.resize_images()`](https://www.tensorflow.org/versions/r0.11/api_docs/python/image.html#resize_images). For best results, use [`tf.pad()`](https://www.tensorflow.org/versions/r0.11/api_docs/python/array_ops.html#pad) before doing convolution with [`tf.nn.conv2d()`](https://www.tensorflow.org/versions/r0.11/api_docs/python/nn.html#conv2d) to avoid boundary artifacts.

  ----
  ## Image Generation Results

  Our experience has been that nearest-neighbor resize followed by a convolution works very well, in a wide variety of contexts.

  One case where we've found this approach to help is Generative Adversarial Networks. Simply switching out the standard deconvolutional layers for nearest-neighbor resize followed by convolution causes artifacts of different frequencies to disappear.

  <dt-include src="assets/deconv_fixes.html"></dt-include>

  In fact, the difference in artifacts can be seen before any training occurs.
  If we look at the images the generator produces, initialized with random weights,
  we can already see the artifacts:

  <dt-include src="assets/deconv_fixes_step0.html"></dt-include>

  This suggests that the artifacts are due to this method of generating images, rather than adversarial training.
  (It also suggests that we might be able to learn a lot about good generator design without the slow feedback cycle of training models.)

  Another reason to believe these artifacts aren't GAN specific is that we see them in other kinds of models, and have found that they also go away when we switch to resize-convolution upsampling.
  For example, consider real-time artistic style transfer (<dt-cite key="johnson2016perceptual"></dt-cite>) where a neural net is trained to directly generate style-transferred images.
  We've found these to be vulnerable to checkerboard artifacts (especially when the cost doesn't explicitly resist them).
  However, switching deconvolutional layers for resize-convolution layers makes the artifacts disappear.

  <dt-include src="assets/style_fix.html"></dt-include>

  Forthcoming papers from the Google Brain team will demonstrate the benefits of this technique
  in more thorough experiments and state-of-the-art results.
  (We've chosen to present this technique separately because we felt it merited more detailed discussion, and because it cut across multiple papers.)


  -----
  ## Artifacts in Gradients

  Whenever we compute the gradients of a convolutional layer,
  we do deconvolution (transposed convolution) on the backward pass.
  This can cause checkerboard patterns in the gradient,
  just like when we use deconvolution to generate images.

  The presence of high-frequency "noise" in image model gradients is
  already known in the feature visualization community, where it's a major challenge.
  Somehow, feature visualization methods must compensate for this noise.

  For example, DeepDream (<dt-cite key="mordvintsev2015inceptionism"></dt-cite>)
  seems to cause destructive interference between artifacts in a number of ways,
  such as optimizing many features simultaneously, and optimizing at many offsets and scales.
  In particular, the "jitter" of optimizing at different offsets cancels out some of the checkerboard artifacts.


  <dt-include src="assets/deepdream_fix.html"></dt-include>

  (While much some of the artifacts are our standard checkerboard pattern,
  others are a less organized high-frequency pattern.
  We believe these to be caused by max pooling.
  Max pooling was previously linked to high-frequency artifacts in <dt-cite key="henaff2015geodesics"></dt-cite>.)
  <!--when interpolating between image representations
  in [Henaff & Simoncelli, 2015](https://arxiv.org/pdf/1409.1556.pdf) -- they recommend using L2 pooling instead.)-->


  <!-- TODO: Should we talk about max pooling, Googlenet vs Inception? -->

  <!--This means that some neurons will get many times the gradient of their neighbors, basically arbitrarily.
  Equivalently, the network will care much more about some pixels in the input than others, for no good reason.
  This strange property is wide spread among modern vision models, and it suggests a number of questions.-->

  More recent work in feature visualization (eg. <dt-cite key="mordvintsev2016deepdreaming"></dt-cite>),
  has explicitly recognized and compensated for these high-frequency gradient components.
  One wonders if better neural network architectures could make these efforts unnecessary.

  Do these gradient artifacts affect GANs?
  If gradient artifacts can affect an image being optimized based on a neural networks gradients in feature visualization,
  we might also expect it to affect the family of images parameterized by the generator as they're optimized by the discriminator in GANs.

  We've found that this does happen in some cases.
  When the generator is neither biased for or against checkerboard patterns,
  strided convolutions in the discriminator can cause them.

  <dt-include src="assets/discrim_fixes.html"></dt-include>

  It's unclear what the broader implications of these gradient artifacts are.
  One way to think about them is that some neurons will get many times the gradient of their neighbors, basically arbitrarily.
  Equivalently, the network will care much more about some pixels in the input than others, for no good reason.
  Neither of those sounds ideal.

  It seems possible that having some pixels affect the network output much more than others may exaggerate adversarial counter-examples.
  Because the derivative is concentrated on small number of pixels,
  small perturbations of those pixels may have outsized effects.
  We have not investigated this.

  <!--
  * **Generative Adverserial Network**:
  One thing you might wonder about is the artifacts in GAN produced images.
  We've seen that standard deconvolution-based generators are biased towards creating them,
  but could a bias in the discriminators makes it hard for them to catch these artifacts, or even encourage them?

  * **Training Neural Networks**:
  If some neurons get many times the gradient of others, does that present a challenge for training?
  Is it an argument for optimizers like ADAM, which are invariant to the scale of the gradient different neurons get?

  * **Adversarial Counter-Examples**:
  Does having some pixels affect the network output much more than others exaggerate adversarial counter-examples?
  Because the derivative is concentrated on small number of pixels,
  small perturbations of those pixels may have outsized effects.

  * **Feature Visualization**:
  A major challenge for optimization-based feature visualization in vision models is that the gradient of the models we are visualizing seem to be dominated by high frequency components ([Mordvintsev, 2016](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/examples/tutorials/deepdream/deepdream.ipynb)).
  Successful visualizations compensate for this in a variety of ways.
  However, one wonders if this high-frequency noise is just an artifact of strided convolutions.
  If so, the issue might just go away if we didn't use them.
  -->

  ---
  ## Conclusion

  The standard approach of producing images with deconvolution -- despite its successes! -- has some very conceptually simple issues that lead to artifacts in produced images.
  Using a natural alternative without these issues causes the artifacts to go away
  (Analogous arguments suggest that standard strided convolutional layers may also have issues).

  This seems like an exciting opportunity to us!
  It suggests that there is low-hanging fruit to be found in carefully thinking through neural network architectures, even ones where we seem to have clean working solutions.

  In the meantime, we've provided an easy to use solution that improves the quality of many approaches to generating images with neural networks. We look forward to seeing what people do with it, and whether it helps in domains like audio, where high frequency artifacts would be particularly problematic.

</dt-article>

<dt-appendix>

  <h3>Acknowledgments</h3>

  <p>We are very grateful to Shan Carter for his wonderful improvements to the first interactive diagram, design advice, and editorial taste.
  We're also very grateful to David Dohan for providing us with an example of strided convolutions in discriminators causing artifacts
  and to Mike Tyka who originally pointed out the connection between jitter and artifacts in DeepDream to us.</p>

  <p>Thank you also to Luke Vilnis, Jon Shlens, Luke Metz, Alex Mordvintsev, and Ben Poole for their feedback and encouragement.</p>

  <p>This work was made possible by the support of the <a href="https://research.google.com/teams/brain/">Google Brain</a> team. Augustus Odena's work was done as part of the <a href="https://research.google.com/teams/brain/residency/">Google Brain Residency Program</a>. Vincent Dumoulin did this while visiting the Brain Team as an intern.</p>

  <h3>Author Contributions</h3>

  <p>Augustus and Chris recognized the connection between deconvolution and artifacts. Augustus ran the GAN experiments. Vincent ran the artistic style transfer experiments. Chris ran the DeepDream experiments, created the visualizations and wrote most of the article.</p>


</dt-appendix>
<dt-footer></dt-footer>

<!-- <h3>References</h3>
<ul class="references">
<li><a href="https://arxiv.org/pdf/1501.00092.pdf">Dong, C., Loy, C.C., He, K. and Tang, X., 2014. <b>Image super-resolution using deep convolutional networks.</b> arXiv preprint arXiv:1501.00092.</a></li>
<li><a href="https://arxiv.org/pdf/1606.00704.pdf">Dumoulin, V., Belghazi, I., Poole, B., Lamb, A., Arjovsky, M., Mastropietro, O. and Courville, A., 2016. <b>Adversarially Learned Inference</b>. arXiv preprint arXiv:1606.00704.</a></li>
<li><a href="https://arxiv.org/pdf/1603.07285.pdf">Dumoulin, V. and Visin, F., 2016. <b>A guide to convolution arithmetic for deep learning</b>. arXiv preprint arXiv:1603.07285.</a></li>
<li><a href="https://arxiv.org/pdf/1605.09782.pdf">Donahue, J., Krähenbühl, P. and Darrell, T., 2016. <b>Adversarial Feature Learning</b>. arXiv preprint arXiv:1605.09782.</a></li>
<li><a href="http://www.foldl.me/uploads/papers/tr-cgans.pdf">Gauthier, J., 2015. <b>Conditional generative adversarial networks for convolutional face generation</b>. Technical report.</a></li>
<li><a href="https://arxiv.org/pdf/1511.06394.pdf">Hénaff, O. J., & Simoncelli, E. P. (2015). <b>Geodesics of learned representations.</b> arXiv preprint arXiv:1511.06394.</a></li>
<li><a href="https://arxiv.org/pdf/1603.08155.pdf">Johnson, J., Alahi, A. and Fei-Fei, L., 2016. <b>Perceptual losses for real-time style transfer and super-resolution</b>. arXiv preprint arXiv:1603.08155.</a></li>
<li><a href="https://research.googleblog.com/2015/06/inceptionism-going-deeper-into-neural.html"> Mordvintsev, A., Olah, C., & Tyka, M. (2015). <b>Inceptionism: Going deeper into neural networks.</b> Google Research Blog.</a></li>
<li><a href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/examples/tutorials/deepdream/deepdream.ipynb"> Mordvintsev, A., 2016. <b>DeepDreaming with TensorFlow</b>. Github.</a></li>
<li><a href="https://arxiv.org/pdf/1511.06434.pdf">Radford, A., Metz, L. and Chintala, S., 2015. <b>Unsupervised representation learning with deep convolutional generative adversarial networks</b>. arXiv preprint arXiv:1511.06434.</a></li>
<li><a href="https://arxiv.org/pdf/1606.03498.pdf">Salimans, T., Goodfellow, I., Zaremba, W., Cheung, V., Radford, A. and Chen, X., 2016. <b>Improved techniques for training GANs</b>. arXiv preprint arXiv:1606.03498.</a></li>
<li><a href="https://arxiv.org/pdf/1609.07009.pdf">Shi, W., Caballero, J., Theis, L., Huszar, F., Aitken, A., Ledig, C. and Wang, Z., 2016. <b>Is the deconvolution layer the same as a convolutional layer?</b>. arXiv preprint arXiv:1609.07009.</a></li>
<li><a href="https://arxiv.org/pdf/1609.05158.pdf">Shi, W., Caballero, J., Huszár, F., Totz, J., Aitken, A.P., Bishop, R., Rueckert, D. and Wang, Z., 2016. <b>Real-Time Single Image and Video Super-Resolution Using an Efficient Sub-Pixel Convolutional Neural Network.</b> In Proceedings of the IEEE Conference on Computer Vision and Pattern Recognition (pp. 1874-1883).</a></li>
</ul> -->


<script type="text/bibliography">
@article{dong2014image,
  title={Image super-resolution using deep convolutional networks},
  author={Dong, Chao and Loy, Chen Change and He, Kaiming and Tang, Xiaoou},
  journal={arXiv preprint arXiv:1501.00092},
  year={2014},
  url={https://arxiv.org/pdf/1501.00092.pdf}
}

@article{dumoulin2016adversarially,
  title={Adversarially Learned Inference},
  author={Dumoulin, Vincent and Belghazi, Ishmael and Poole, Ben and Lamb, Alex and Arjovsky, Martin and Mastropietro, Olivier and Courville, Aaron},
  journal={arXiv preprint arXiv:1606.00704},
  year={2016},
  url={https://arxiv.org/pdf/1606.00704.pdf}
}

@article{dumoulin2016guide,
  title={A guide to convolution arithmetic for deep learning},
  author={Dumoulin, Vincent and Visin, Francesco},
  journal={arXiv preprint arXiv:1603.07285},
  year={2016},
  url={https://arxiv.org/pdf/1603.07285.pdf}
}

@article{donahue2016adversarial,
  title={Adversarial Feature Learning},
  author={Donahue, Jeff and Kr{\"a}henb{\"u}hl, Philipp and Darrell, Trevor},
  journal={arXiv preprint arXiv:1605.09782},
  year={2016},
  url={https://arxiv.org/pdf/1605.09782.pdf}
}

@article{gauthier2014conditional,
  title={Conditional generative adversarial nets for convolutional face generation},
  author={Gauthier, Jon},
  journal={Class Project for Stanford CS231N: Convolutional Neural Networks for Visual Recognition, Winter semester},
  volume={2014},
  year={2014},
  url={http://www.foldl.me/uploads/papers/tr-cgans.pdf}
}

@article{henaff2015geodesics,
  title={Geodesics of learned representations},
  author={H{\'e}naff, Olivier J and Simoncelli, Eero P},
  journal={arXiv preprint arXiv:1511.06394},
  year={2015},
  url={https://arxiv.org/pdf/1511.06394.pdf}
}

@article{johnson2016perceptual,
  title={Perceptual losses for real-time style transfer and super-resolution},
  author={Johnson, Justin and Alahi, Alexandre and Fei-Fei, Li},
  journal={arXiv preprint arXiv:1603.08155},
  year={2016},
  url={https://arxiv.org/pdf/1603.08155.pdf}
}

@article{mordvintsev2015inceptionism,
  title={Inceptionism: Going deeper into neural networks},
  author={Mordvintsev, Alexander and Olah, Christopher and Tyka, Mike},
  journal={Google Research Blog. Retrieved June},
  volume={20},
  year={2015},
  url={https://research.googleblog.com/2015/06/inceptionism-going-deeper-into-neural.html}
}

@misc{mordvintsev2016deepdreaming,
  title={DeepDreaming with TensorFlow},
  author={Mordvintsev, Alexander},
  year={2016},
  url={https://github.com/tensorflow/tensorflow/blob/master/tensorflow/examples/tutorials/deepdream/deepdream.ipynb},
}

@article{radford2015unsupervised,
  title={Unsupervised representation learning with deep convolutional generative adversarial networks},
  author={Radford, Alec and Metz, Luke and Chintala, Soumith},
  journal={arXiv preprint arXiv:1511.06434},
  year={2015},
  url={https://arxiv.org/pdf/1511.06434.pdf}
}

@inproceedings{salimans2016improved,
  title={Improved techniques for training gans},
  author={Salimans, Tim and Goodfellow, Ian and Zaremba, Wojciech and Cheung, Vicki and Radford, Alec and Chen, Xi},
  booktitle={Advances in Neural Information Processing Systems},
  pages={2226--2234},
  year={2016},
  url={https://arxiv.org/pdf/1606.03498.pdf}
}

@article{shi2016deconvolution,
  title={Is the deconvolution layer the same as a convolutional layer?},
  author={Shi, Wenzhe and Caballero, Jose and Theis, Lucas and Huszar, Ferenc and Aitken, Andrew and Ledig, Christian and Wang, Zehan},
  journal={arXiv preprint arXiv:1609.07009},
  year={2016},
  url={https://arxiv.org/pdf/1609.07009.pdf}
}

@inproceedings{shi2016real,
  title={Real-time single image and video super-resolution using an efficient sub-pixel convolutional neural network},
  author={Shi, Wenzhe and Caballero, Jose and Husz{\'a}r, Ferenc and Totz, Johannes and Aitken, Andrew P and Bishop, Rob and Rueckert, Daniel and Wang, Zehan},
  booktitle={Proceedings of the IEEE Conference on Computer Vision and Pattern Recognition},
  pages={1874--1883},
  year={2016},
  url={https://arxiv.org/pdf/1609.05158.pdf},
  doi={10.1109/cvpr.2016.207}
}

</script>
